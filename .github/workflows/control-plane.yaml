name: Control Plane CI/CD - Deploy to EC2

on:
  push:
    branches:
      - master
    paths:
      - 'control-plane/**'
      - '.github/workflows/control-plane.yaml'
  workflow_dispatch:

env:
  EC2_HOST: 13.49.148.250
  EC2_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/lighter-k8/control-plane

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          # Copy files to EC2
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude 'target/' \
            --exclude '.git/' \
            ./control-plane/ \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:/home/ubuntu/lighter-k8/control-plane/
          
          # Build and restart on EC2
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }} bash << 'EOF'
            pkill -f control-plane || true
            cd /home/ubuntu/lighter-k8/control-plane
            source $HOME/.cargo/env
            nohup cargo run --release > /tmp/control-plane.log 2>&1 &
            sleep 10
            if pgrep -f control-plane > /dev/null; then
              echo "✅ Control plane running"
            else
              echo "❌ Failed to start"
              tail -50 /tmp/control-plane.log
              exit 1
            fi
          EOF

      - name: Health check
        run: |
          for i in {1..30}; do
            if curl -sf http://${{ env.EC2_HOST }}:8080/health > /dev/null 2>&1; then
              echo "✅ Deployment successful - http://${{ env.EC2_HOST }}:8080"
              exit 0
            fi
            sleep 2
          done
          echo "❌ Health check failed"
          exit 1
