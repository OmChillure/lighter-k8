name: Control Plane CI/CD - Deploy to EC2

on:
  push:
    branches:
      - master
    paths:
      - 'control-plane/**'
      - '.github/workflows/control-plane.yaml'
  workflow_dispatch:

env:
  EC2_HOST: 13.49.148.250
  EC2_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/lighter-k8/control-plane

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          # Copy files to EC2
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude 'target/' \
            --exclude '.git/' \
            ./control-plane/ \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:/home/ubuntu/lighter-k8/control-plane/
          
          # Build and restart on EC2
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }} bash << 'EOF'
            set -e
            
            # Kill existing process
            pkill -f control-plane || true
            
            # Navigate to control-plane directory
            cd /home/ubuntu/lighter-k8/control-plane
            
            echo "üìÅ Current directory: $(pwd)"
            
            # Load cargo
            if [ -f "$HOME/.cargo/env" ]; then
              source "$HOME/.cargo/env"
            fi
            
            # Check .env file
            if [ -f .env ]; then
              echo "‚úÖ .env file found"
              echo "üìã .env file location: $(pwd)/.env"
            else
              echo "‚ùå .env file NOT found!"
              exit 1
            fi
            
            # Start the service with cargo run
            echo "üöÄ Starting control-plane with cargo run..."
            nohup cargo run --release > /tmp/control-plane.log 2>&1 &
            
            # Wait for startup
            sleep 10
            
            # Check if it's running
            if pgrep -f "control-plane" > /dev/null; then
              echo "‚úÖ Control plane deployed and running!"
              ps aux | grep control-plane | grep -v grep
            else
              echo "‚ùå Control plane failed to start"
              echo "Last 50 lines of log:"
              tail -50 /tmp/control-plane.log
              exit 1
            fi
          EOF

      - name: Health check
        run: |
          echo "‚è≥ Waiting for service to start..."
          
          # Retry health check up to 30 times (60 seconds total)
          for i in {1..30}; do
            if curl -f -s http://${{ env.EC2_HOST }}:8080/health > /dev/null 2>&1; then
              echo "‚úÖ Deployment successful! API is healthy."
              echo "üîó API URL: http://${{ env.EC2_HOST }}:8080"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 2
          done
          
          echo "‚ùå Health check failed after 60 seconds"
          echo "Checking if service is running on EC2..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }} \
            "ps aux | grep control-plane | grep -v grep && tail -100 /tmp/control-plane.log"
          exit 1
